services:
  arka-app:
    build: ../ARKA-APP/server
    container_name: arka-app
    environment:
      PYTHONUNBUFFERED: "1"
      ROUTING_URL: http://arka-routing:8087
      DATABASE_URL: postgresql+psycopg2://${POSTGRES_USER:-arka}:${POSTGRES_PASSWORD:-arka}@postgres:5432/${POSTGRES_DB:-arka}
    volumes:
      - ../ARKA-APP/server:/app:rw
      - ../ARKA_OS:/app/ARKA_OS:ro
      - ../ARKA_META:/app/ARKA_META
    command: ["uvicorn", "main:APP", "--host", "0.0.0.0", "--port", "8080"]
    ports:
      - "${ARKA_APP_PORT:-8080}:8080"
    depends_on:
      arka-routing:
        condition: service_healthy
      postgres:
        condition: service_healthy

  arka-web:
    image: node:20-alpine
    container_name: arka-web
    working_dir: /app
    volumes:
      - ../ARKA-APP/web:/app
    environment:
      - VITE_API_URL=http://arka-app:8080/api
    command: ["sh","-lc","npm install && npm run dev -- --host 0.0.0.0 --port 5173"]
    ports:
      - "5173:5173"
    depends_on:
      arka-app:
        condition: service_started
